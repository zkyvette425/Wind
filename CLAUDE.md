# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

# 🚨🚨🚨 变更记录强制要求 - 用户已提醒4次！🚨🚨🚨

## ⛔ 绝对不可忽视的强制规范 - 禁止再次遗忘！⛔

**每次代码修改后，必须立即执行以下三步，否则严禁继续工作：**

### 🔴 强制执行清单（每次代码修改后必检查）:
1. ✅ **更新TODO状态** - 标记为"已完成 + 已测试"
2. 📝 **更新变更记录** - 在 `plans/版本变更日志.md` 中添加详细记录
3. 📄 **更新相关文档** - 同步更新所有受影响的文档

### 📋 变更记录详细要求:
- 使用准确的北京时间（通过`date`命令获取）
- 记录具体的代码行数、文件数、测试数据
- 使用标准变更标记：➕新增/🔄修改/❌移除/🧪测试/📦配置
- 说明变更原因和影响范围

**⚠️ 重要：用户对此要求已提醒4次 - 绝对不能再忘记！⚠️**

## 🚨 重要提醒 - 项目纲领系统

### 命令行要求
- 使用中文沟通
- 使用Windows命令行语法

### ⏰ 时间标准 (重要!)
- **项目时间标准**: 统一使用北京时间 (UTC+8)
- **项目创建时间**: 2025年8月11日 (北京时间)
- **所有文档日期均使用北京时间标准**

### 📅 时间获取规范 (新增 - 2025-08-13)
- **准确获取**: 使用`date`命令或WebSearch查询当前北京时间
- **禁止猜测**: 严禁估算或猜测日期时间
- **实时更新**: 每次记录TODO完成时间都必须获取当前准确时间
- **格式要求**: 使用"YYYY年MM月DD日"或"YYYY-MM-DD"格式

### 📍 纲领位置和获取方式
- **完整纲领文档**: `plans/纲领.md` - 包含所有技术决策、架构原则和开发规范
- **工作模式指导**: 本文件仅为快速引导，详细指导在纲领文档中

### 🔄 上下文恢复机制
**如果上下文发生切换，必须按以下步骤恢复项目一致性：**

1. **阅读纲领文档** (`plans/纲领.md`) - 了解完整的项目愿景和技术决策
2. **检查当前TODO** (`plans/v1.0-基础架构.md` 等) - 了解当前进展状态  
3. **查阅变更记录** (`plans/版本变更日志.md`) - 了解最新的变更情况
4. **Context7文档查阅** - 确保使用最新技术文档

### 🔒 强制文档检查触发机制

#### 每次会话开始时必须检查：
- ✅ 本文件 (`CLAUDE.md`) - 核心工作规范和检查清单
- ✅ 当前阶段TODO (`plans/v1.0-基础架构.md` 或 `plans/v1.1-核心服务.md`)
- ✅ 最新变更记录 (`plans/版本变更日志.md` 最后3条记录)

#### 标记"已测试"前必须检查：
- 🧪 测试验证管理 (`plans/测试验证管理.md`) - 强制测试流程检查清单
- 🧪 运行实际测试验证，不允许假测试

#### 发现质量问题时必须检查：
- 🚨 质量事故档案 (`plans/质量事故档案.md`) - 查看是否为已知问题，记录新问题

#### 技术决策和架构变更时必须检查：
- 📋 纲领文档 (`plans/纲领.md`) - 确保决策符合项目原则
- 📋 技术研究记录 (`plans/技术研究记录.md`) - 查阅相关技术调研
- 📋 决策记录 (`plans/决策记录.md`) - 记录重要决策

### 📋 TODO列表工作模式 ⚡ 严格执行！
- **双重完成标准**: 每个任务必须标记 ✅ 已完成 + 🧪 已测试
- **逐个任务标记**: 完成一个任务立即标记，不能批量处理
- **完成时间记录**: 必须添加 📅 完成日期 (北京时间)
- **🚨🚨 变更记录强制要求 🚨🚨**: 任何修改都要更新对应的变更记录文档 - 用户已提醒4次！
- **版本化管理**: 当前版本所有任务完成后才进入下一版本
- **🚨 执行检查**: 每次完成代码修改后，必须检查并更新TODO状态

#### 🔴 变更记录强制流程（禁止跳过）:
1. **立即更新TODO状态** - 标记✅已完成🧪已测试
2. **立即更新变更记录** - `plans/版本变更日志.md`添加详细记录
3. **立即更新相关文档** - 同步更新所有受影响文档
4. **使用准确时间** - 通过`date`命令获取北京时间
5. **记录具体数据** - 代码行数、文件数、测试结果等

**⚠️ 警告：用户已为此要求提醒4次，绝对禁止再次遗忘！⚠️**

## 🔄 关键工作流程检查点

**目标**: 通过简洁的流程指引，确保关键时期做对的事情，避免严重质量问题。

### 📋 工作流程节点

#### 🎯 开始任务时 (必读文档)
- 📖 **必读**: `plans/纲领.md` - 了解项目方向和技术决策
- 📖 **必读**: 当前版本TODO文档 (如`plans/v1.1-核心服务.md`) - 了解任务背景和验收标准

#### 🔧 编写代码时 (技术参考)
- 📖 **必读**: `docs/Orleans开发规范.md` - 遵循技术规范
- 📖 **必查**: Context7技术文档 - 确保使用最新API和最佳实践

#### ✅ 标记完成前 (强制验证 - 绝不跳过!)
- 🔴 **必执行**: `dotnet build Wind.sln` - 确保0错误0警告
- 🔴 **必读**: `plans/质量事故档案.md` - 避免重复历史错误
- 🔴 **必更新**: `plans/版本变更日志.md` - 记录详细变更信息
- 🔴 **必验证**: 实际测试声称的功能 - 确保真正可用

#### 🚨 遇到问题时 (问题处理)
- 📖 **必查**: `plans/质量事故档案.md` - 确认是否为已知问题
- ✍️ **必记录**: 新问题到质量事故档案 - 建立防范机制

### 🛡️ 核心质量检查点

**每次标记"✅已完成🧪已测试"前，必须通过以下4项检查：**

1. **🔧 构建验证**: `dotnet build Wind.sln` 通过且0错误0警告
2. **📝 变更记录**: 更新版本变更日志，使用准确时间和具体数据
3. **🔗 兼容性**: 新技术集成已验证，配置变更已测试
4. **✅ 功能验证**: 实际测试功能可用，可诚实向用户汇报

**🚨 如果任何一项未通过，绝对禁止标记为"已完成"！**

### 📋 质量原则

- **零容忍**: 对质量事故零容忍
- **诚实**: 宁可汇报问题，不虚假完成  
- **敬畏**: 对用户要求保持敬畏
- **持续改进**: 从错误中学习

**💡 详细的质量事故档案和防范措施请查看 `plans/质量事故档案.md`**

---

## 🎯 项目概述

这是一个基于 **.NET 9 + Microsoft Orleans + MagicOnion** 的现代化分布式游戏服务器框架。项目已从传统分层架构完全重构为Actor模型，专为高并发多人在线游戏设计。

### Context7 文档查阅原则 🔍 **最高优先级**

**在编写任何代码前，必须先通过 Context7 查阅对应技术的最新官方文档！**

必须查阅的核心技术：
- Microsoft Orleans 9.2.1
- MagicOnion (gRPC + MessagePack)
- Redis Stack
- MongoDB EF Core Provider
- .NET 9 性能优化

## 🏗️ 当前架构设计 (v1.0阶段)

### 项目结构 (彻底重构完成)
```
Wind/
├── plans/                    # 📋 项目管理文档系统
├── Wind.Server/              # 🎮 Orleans Silo宿主 (已完全清理)
├── Wind.GrainInterfaces/     # 📄 Grain接口定义 (已创建)
├── Wind.Grains/             # ⚡ Orleans Grain实现 (已创建)
├── Wind.Shared/             # 📦 消息协议 (仅保留Protocols)
├── Wind.Client/             # 🔌 客户端SDK (已创建)
└── Wind.Tests/              # 🧪 测试套件 (已完全清理)
```

### 技术栈
- **运行时**: .NET 9 (最新性能优化)
- **分布式框架**: Microsoft Orleans 9.2.1 (Virtual Actor模型)
- **网络通信**: MagicOnion (gRPC + MessagePack，专为游戏设计)
- **数据存储**: Redis Stack (缓存) + MongoDB (持久化)
- **测试框架**: xUnit + Moq (集成测试优先)

## 🔧 开发命令 (当前阶段)

### 构建和运行
```bash
# 构建解决方案 (Orleans项目)
dotnet build Wind.sln

# 运行Orleans Silo (重构后)
dotnet run --project Wind.Server\Wind.Server.csproj

# 还原NuGet包 (包含Orleans/MagicOnion)
dotnet restore
```

### 测试命令
```bash
# 运行所有测试 (Actor模型测试)
dotnet test Wind.sln

# 运行集成测试 (分布式场景)
dotnet test Wind.Tests\Wind.Tests.csproj

# 性能测试 (Orleans Grain性能)
dotnet test --collect:"XPlat Code Coverage"
```

## 📈 开发进度追踪

### 当前状态: v1.0 基础架构搭建
- ✅ 完整文档体系建立
- ✅ 架构彻底清理和重构
- ✅ 纯净Orleans项目结构创建
- ⏳ Orleans包安装和Silo配置 (下一步)
- ⏳ MagicOnion网络层集成
- ⏳ 代码规范和开发环境

### 服务器运行配置
- Orleans Silo端口: 待配置
- MagicOnion gRPC端口: 待配置  
- 管理端口: 待配置

## ⚠️ 重要注意事项

### 架构迁移状态 (彻底重构完成)
1. **已彻底删除**: Wind.Application, Wind.Domain, Wind.Infrastructure, Wind.Core
2. **已完全清理**: Wind.Server (删除Controllers/Hubs，重写Program.cs)
3. **已创建完成**: Wind.Grains, Wind.GrainInterfaces, Wind.Client (纯净Orleans项目)

### 🚨🚨 变更记录强制要求 - 用户已提醒4次！🚨🚨
**绝对禁止跳过的强制流程：**
任何代码修改必须同时更新：
- ✅ 对应的TODO状态 (已完成 + 已测试)
- 📝 相关变更记录文档 (`plans/版本变更日志.md` 等)
- 📄 影响的其他文档
- ⏰ 使用准确的北京时间（通过`date`命令获取）
- 📊 记录具体数据（代码行数、文件数、测试结果）

**⚠️ 严重警告：用户已为此规范提醒4次，再次遗忘将导致严重后果！⚠️**

### 学习和文档
- 📚 **强制要求**: 使用任何新技术前先通过Context7查阅最新文档
- 📝 **记录变更**: 每次修改都要记录原因和影响范围
- 🧪 **测试标准**: 集成测试 > 单元测试 > 性能测试的优先级

## 🎮 核心业务组件 (规划中)

### Orleans Grain架构 (v1.1目标)
- **PlayerGrain**: 玩家状态和行为管理
- **RoomGrain**: 游戏房间和匹配逻辑
- **CombatGrain**: 战斗系统处理
- **ChatGrain**: 聊天和社交功能

### 数据存储策略 (v1.2目标)
- **Redis**: 实时数据、会话、排行榜
- **MongoDB**: 玩家档案、游戏记录、配置

### 性能目标
- 并发连接: > 10,000
- 响应延迟: < 50ms  
- 内存效率: 单Grain < 1MB

---

**🚨 关键提醒**: 本文件是快速参考，完整的项目指导和决策依据请查看 `plans/纲领.md`。在任何重大决策前，务必参考纲领文档确保一致性。

---

# 🚨🚨🚨 最终提醒 - 变更记录强制要求 🚨🚨🚨

## ⛔ 每次代码修改后必须执行 - 用户已提醒4次！⛔

**强制检查清单（禁止跳过）:**
1. ✅ 更新TODO状态为"已完成 + 已测试"
2. 📝 更新 `plans/版本变更日志.md` 详细记录
3. 📄 更新所有受影响的相关文档
4. ⏰ 使用`date`命令获取准确北京时间
5. 📊 记录具体数据（代码行数、文件数、测试结果）

**🚨 绝对禁止再次遗忘此要求！用户对此已提醒4次！🚨**