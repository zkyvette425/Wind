# Redisæµ‹è¯•ç¯å¢ƒä½¿ç”¨æŒ‡å—

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
> **åˆ›å»ºæ—¶é—´**: 2025-08-15  
> **é€‚ç”¨é¡¹ç›®ç‰ˆæœ¬**: Wind v1.2+  
> **å…³è”é…ç½®**: `tools/redis-testing/docker-compose.test.yml`, `Wind.Server/appsettings.json`  
> **æœ€åæ›´æ–°**: 2025-08-15  

---

## ğŸ“‹ ç‰ˆæœ¬å˜æ›´å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ | å½±å“èŒƒå›´ |
|------|------|----------|----------|
| v1.0.0 | 2025-08-15 | åˆ›å»ºRedisæµ‹è¯•ç¯å¢ƒæ–‡æ¡£å’Œå·¥å…·åŒ… | æ–°å¢åŠŸèƒ½ |

---

> **é€‚ç”¨äººç¾¤**: Redisæ–°æ‰‹ï¼Œéœ€è¦è¿è¡ŒWindé¡¹ç›®ä¸­çš„Redisç›¸å…³æµ‹è¯•  
> **å‰ææ¡ä»¶**: å·²å®‰è£…Docker Desktop  
> **é¢„è®¡ç”¨æ—¶**: 5åˆ†é’Ÿè®¾ç½®ï¼Œ2åˆ†é’Ÿæ—¥å¸¸ä½¿ç”¨  

## ğŸš€ å¿«é€Ÿå¼€å§‹ï¼ˆ3æ­¥å®Œæˆï¼‰

### ç¬¬1æ­¥ï¼šå¯åŠ¨Redisç¯å¢ƒ
```bash
# è¿›å…¥å·¥å…·ç›®å½•å¹¶æ‰§è¡Œï¼š
cd tools/redis-testing
.\start.bat
```
**é¢„æœŸç»“æœ**: çœ‹åˆ°"âœ… Redisæµ‹è¯•ç¯å¢ƒå¯åŠ¨æˆåŠŸï¼"

### ç¬¬2æ­¥ï¼šè¿è¡ŒRedisæµ‹è¯•
```bash
# åœ¨tools/redis-testingç›®å½•æ‰§è¡Œï¼š
run-tests.bat
```
**é¢„æœŸç»“æœ**: æ‰€æœ‰Redisæµ‹è¯•é€šè¿‡ï¼Œæ˜¾ç¤ºç»¿è‰²âœ…æ ‡è®°

### ç¬¬3æ­¥ï¼šåœæ­¢ç¯å¢ƒï¼ˆå¯é€‰ï¼‰
```bash
# æµ‹è¯•å®Œæˆåæ¸…ç†ï¼š
stop.bat
```

## ğŸ“‹ è¯¦ç»†æ“ä½œæŒ‡å—

### ğŸ¯ æµ‹è¯•ç±»å‹è¯´æ˜

æˆ‘ä»¬çš„é¡¹ç›®åŒ…å«3ç±»Redisç›¸å…³æµ‹è¯•ï¼š

#### 1. **é›†æˆæµ‹è¯•** (éœ€è¦çœŸå®Redis)
- `RedisStorageValidationTests` - éªŒè¯Orleansçš„Rediså­˜å‚¨åŠŸèƒ½
- `RedisCacheStrategyTests` - éªŒè¯Redisç¼“å­˜å’ŒTTLç­–ç•¥
- **æ ‡è®°**: `[Trait("Category", "Integration")]`
- **è¿è¡Œå‘½ä»¤**: `dotnet test --filter Category=Integration`

#### 2. **å•å…ƒæµ‹è¯•** (æ— éœ€Redis)
- `RedisCacheStrategyMockTests` - Mockæµ‹è¯•ï¼ŒéªŒè¯ä¸šåŠ¡é€»è¾‘
- **æ ‡è®°**: `[Trait("Category", "Unit")]`
- **è¿è¡Œå‘½ä»¤**: `dotnet test --filter Category=Unit`

#### 3. **å®Œæ•´æµ‹è¯•å¥—ä»¶**
- åŒ…å«æ‰€æœ‰æµ‹è¯•ï¼ˆé›†æˆ+å•å…ƒ+å…¶ä»–ï¼‰
- **è¿è¡Œå‘½ä»¤**: `dotnet test Wind.sln`

### ğŸ”§ ç¯å¢ƒé…ç½®è¯¦æƒ…

#### Dockerå®¹å™¨é…ç½®
- **Redisç‰ˆæœ¬**: 7.2-alpine (è½»é‡çº§ï¼Œå¿«é€Ÿå¯åŠ¨)
- **ç«¯å£æ˜ å°„**: 6379:6379 (æ ‡å‡†Redisç«¯å£)
- **å¯†ç **: windgame123 (ä¸é¡¹ç›®é…ç½®ä¸€è‡´)
- **æ•°æ®åº“**: æ”¯æŒ0-15ï¼Œæµ‹è¯•ä½¿ç”¨0,1,2
- **å†…å­˜é™åˆ¶**: 256MB (æµ‹è¯•å¤Ÿç”¨)
- **æ•°æ®æŒä¹…åŒ–**: å¯ç”¨AOFå’ŒRDBåŒé‡ä¿éšœ

#### å¥åº·æ£€æŸ¥
- **æ£€æŸ¥é—´éš”**: 30ç§’
- **è¶…æ—¶æ—¶é—´**: 10ç§’
- **é‡è¯•æ¬¡æ•°**: 3æ¬¡
- **å¯åŠ¨ç­‰å¾…**: 30ç§’

## ğŸ§ª æµ‹è¯•é€‰é¡¹è¯¦è§£

è¿è¡Œ`run-tests.bat`æ—¶ä¼šçœ‹åˆ°5ä¸ªé€‰é¡¹ï¼š

### é€‰é¡¹1: è¿è¡Œæ‰€æœ‰Redisé›†æˆæµ‹è¯• â­ æ¨è
```bash
dotnet test Wind.sln --filter "Category=Integration"
```
- **åŒ…å«**: æ‰€æœ‰éœ€è¦Redisçš„æµ‹è¯•
- **ç”¨é€”**: éªŒè¯RedisåŠŸèƒ½æ˜¯å¦æ­£å¸¸
- **æ—¶é—´**: çº¦30-60ç§’

### é€‰é¡¹2: è¿è¡ŒRediså­˜å‚¨éªŒè¯æµ‹è¯•
```bash
dotnet test --filter "FullyQualifiedName~RedisStorageValidationTests"
```
- **åŒ…å«**: Orleans Rediså­˜å‚¨åŠŸèƒ½
- **æµ‹è¯•**: ç©å®¶ç™»å½•ã€çŠ¶æ€æŒä¹…åŒ–ã€è·¨Grainç”Ÿå‘½å‘¨æœŸ
- **ç”¨é€”**: éªŒè¯Orleansé…ç½®æ˜¯å¦ä½¿ç”¨Rediså­˜å‚¨

### é€‰é¡¹3: è¿è¡ŒRedisç¼“å­˜ç­–ç•¥æµ‹è¯•
```bash
dotnet test --filter "FullyQualifiedName~RedisCacheStrategyTests"
```
- **åŒ…å«**: TTLç­–ç•¥ã€ç¼“å­˜æ€§èƒ½ã€æ‰¹é‡æ“ä½œ
- **æµ‹è¯•**: ä¸åŒæ•°æ®ç±»å‹çš„è¿‡æœŸæ—¶é—´ã€ç¼“å­˜ç»Ÿè®¡
- **ç”¨é€”**: éªŒè¯ç¼“å­˜åŠŸèƒ½å’Œæ€§èƒ½

### é€‰é¡¹4: è¿è¡ŒRedis Mockæµ‹è¯• âš¡ æœ€å¿«
```bash
dotnet test --filter "FullyQualifiedName~RedisCacheStrategyMockTests"
```
- **åŒ…å«**: çº¯é€»è¾‘æµ‹è¯•ï¼Œæ— Redisä¾èµ–
- **æµ‹è¯•**: TTLæ˜ å°„ã€é…ç½®éªŒè¯ã€åºåˆ—åŒ–
- **ç”¨é€”**: å¿«é€ŸéªŒè¯ä¸šåŠ¡é€»è¾‘æ­£ç¡®æ€§
- **ä¼˜åŠ¿**: æ— éœ€å¯åŠ¨Redisï¼Œç§’çº§å®Œæˆ

### é€‰é¡¹5: è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
```bash
dotnet test Wind.sln
```
- **åŒ…å«**: é¡¹ç›®ä¸­æ‰€æœ‰æµ‹è¯•
- **ç”¨é€”**: å®Œæ•´å›å½’æµ‹è¯•
- **æ—¶é—´**: çº¦2-5åˆ†é’Ÿ

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜1: Dockeræœªå¯åŠ¨
**é”™è¯¯ä¿¡æ¯**: "âŒ é”™è¯¯: æœªæ£€æµ‹åˆ°Docker Desktop" æˆ– "Docker Desktopæœªå®Œå…¨å¯åŠ¨"

**è§£å†³æ–¹æ¡ˆ**:
1. å¯åŠ¨Docker Desktopåº”ç”¨ç¨‹åº
2. ç­‰å¾…Dockerå®Œå…¨å¯åŠ¨ï¼ˆç³»ç»Ÿæ‰˜ç›˜å›¾æ ‡å˜ä¸ºç»¿è‰²ï¼‰
3. å¦‚æœæŒç»­å‡ºç°é—®é¢˜ï¼Œè¿è¡Œ `test-docker.bat` è¿›è¡Œè¯¦ç»†æ£€æŸ¥
4. é‡æ–°è¿è¡Œ`start.bat`

**è¯Šæ–­å·¥å…·**:
```bash
# è¿è¡ŒDockerçŠ¶æ€æµ‹è¯•
cd tools/redis-testing
test-docker.bat
```

### å¸¸è§é—®é¢˜2: ç«¯å£è¢«å ç”¨
**é”™è¯¯ä¿¡æ¯**: "ç«¯å£6379è¢«å ç”¨" æˆ– å®¹å™¨å¯åŠ¨å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ£€æŸ¥ç«¯å£å ç”¨
netstat -an | findstr :6379

# 2. åœæ­¢å ç”¨è¿›ç¨‹ï¼Œæˆ–ä¿®æ”¹é…ç½®ä½¿ç”¨å…¶ä»–ç«¯å£
# 3. é‡æ–°å¯åŠ¨Rediså®¹å™¨
stop.bat
start.bat
```

### å¸¸è§é—®é¢˜3: Redisè¿æ¥å¤±è´¥/å¯åŠ¨è¶…æ—¶
**é”™è¯¯ä¿¡æ¯**: "âŒ é”™è¯¯: RedisæœåŠ¡å¯åŠ¨è¶…æ—¶" æˆ– "æ— æ³•è¿æ¥åˆ°RedisæœåŠ¡"

**ä¸€é”®ä¿®å¤æ–¹æ¡ˆ**:
```bash
# è¿è¡Œè‡ªåŠ¨ä¿®å¤å·¥å…·
fix-redis.bat
```

**æ‰‹åŠ¨è¯Šæ–­æ–¹æ¡ˆ**:
```bash
# 1. è¯¦ç»†è¯Šæ–­RedisçŠ¶æ€
diagnose-redis.bat

# 2. æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps | findstr wind-redis

# 3. æŸ¥çœ‹Redisæ—¥å¿—
docker logs wind-redis-test

# 4. æ‰‹åŠ¨æµ‹è¯•è¿æ¥
docker exec -it wind-redis-test redis-cli -a windgame123 ping
```

**é¢„æœŸç»“æœ**: è¿”å› `PONG`

**å¸¸è§åŸå› å’Œè§£å†³æ–¹æ¡ˆ**:
- **ç«¯å£å ç”¨**: æ£€æŸ¥ç«¯å£6379æ˜¯å¦è¢«å ç”¨
- **æƒé™é—®é¢˜**: ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œè„šæœ¬
- **èµ„æºä¸è¶³**: ç¡®ä¿Dockeræœ‰è¶³å¤Ÿå†…å­˜å’ŒCPU
- **é…ç½®å†²çª**: è¿è¡Œfix-redis.batæ¸…ç†å¹¶é‡å»º

### å¸¸è§é—®é¢˜4: æµ‹è¯•è¶…æ—¶
**é”™è¯¯ä¿¡æ¯**: æµ‹è¯•è¿è¡Œæ—¶é—´è¿‡é•¿æˆ–è¶…æ—¶

**è§£å†³æ–¹æ¡ˆ**:
1. **ç½‘ç»œé—®é¢˜**: æ£€æŸ¥Dockerç½‘ç»œè¿æ¥
2. **èµ„æºä¸è¶³**: å…³é—­å…¶ä»–å ç”¨èµ„æºçš„åº”ç”¨
3. **å®¹å™¨çŠ¶æ€**: é‡å¯Rediså®¹å™¨
```bash
stop.bat
start.bat
```

### å¸¸è§é—®é¢˜5: æƒé™é—®é¢˜
**é”™è¯¯ä¿¡æ¯**: "è®¿é—®è¢«æ‹’ç»" æˆ– æƒé™ç›¸å…³é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
1. **ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ**: å³é”®è„šæœ¬ â†’ "ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ"
2. **Dockeræƒé™**: ç¡®ä¿å½“å‰ç”¨æˆ·åœ¨Dockerç”¨æˆ·ç»„ä¸­
3. **é˜²ç«å¢™è®¾ç½®**: ç¡®ä¿Dockerå¯ä»¥è®¿é—®ç½‘ç»œ

## ğŸ’¡ é«˜çº§ä½¿ç”¨æŠ€å·§

### ğŸ¨ Redisç®¡ç†ç•Œé¢ï¼ˆå¯é€‰ï¼‰
å¦‚éœ€å›¾å½¢åŒ–ç®¡ç†Redisæ•°æ®ï¼š

```bash
# å¯åŠ¨Redis Commanderç®¡ç†ç•Œé¢
docker-compose -f docker-compose.test.yml --profile debug up -d

# è®¿é—®åœ°å€
http://localhost:8081
```

**åŠŸèƒ½**: 
- å¯è§†åŒ–æŸ¥çœ‹Redisæ•°æ®
- å®æ—¶ç›‘æ§å†…å­˜ä½¿ç”¨
- æ‰‹åŠ¨æ“ä½œé”®å€¼å¯¹

### ğŸ“Š å®æ—¶ç›‘æ§RedisçŠ¶æ€
```bash
# æŸ¥çœ‹Redisä¿¡æ¯
docker exec wind-redis-test redis-cli -a windgame123 info

# ç›‘æ§å®æ—¶å‘½ä»¤
docker exec wind-redis-test redis-cli -a windgame123 monitor

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
docker exec wind-redis-test redis-cli -a windgame123 info memory
```

### ğŸ§¹ å­˜å‚¨ç®¡ç†
```bash
# æŸ¥çœ‹æ‰€æœ‰é”®
docker exec wind-redis-test redis-cli -a windgame123 keys "*"

# æ¸…ç©ºæµ‹è¯•æ•°æ®ï¼ˆå°å¿ƒï¼ï¼‰
docker exec wind-redis-test redis-cli -a windgame123 flushall

# æ£€æŸ¥ç‰¹å®šæ•°æ®åº“
docker exec wind-redis-test redis-cli -a windgame123 -n 0 dbsize
```

### âš™ï¸ è‡ªå®šä¹‰é…ç½®

å¦‚éœ€ä¿®æ”¹Redisé…ç½®ï¼Œç¼–è¾‘`docker-compose.test.yml`:

```yaml
# å¸¸ç”¨é…ç½®é¡¹
command: >
  redis-server 
  --requirepass windgame123     # å¯†ç 
  --maxmemory 512mb            # å†…å­˜é™åˆ¶
  --port 6379                  # ç«¯å£
  --databases 16               # æ•°æ®åº“æ•°é‡
```

ä¿®æ”¹åé‡å¯ç¯å¢ƒï¼š
```bash
stop.bat
start.bat
```

## ğŸ“ˆ æ€§èƒ½åŸºå‡†

### é¢„æœŸæµ‹è¯•æ€§èƒ½
- **Mockæµ‹è¯•**: < 1ç§’ï¼ˆæ— Redisä¾èµ–ï¼‰
- **é›†æˆæµ‹è¯•**: 30-60ç§’ï¼ˆåŒ…å«å®¹å™¨å¯åŠ¨ï¼‰
- **å®Œæ•´å¥—ä»¶**: 2-5åˆ†é’Ÿï¼ˆæ‰€æœ‰æµ‹è¯•ï¼‰

### å®¹å™¨èµ„æºä½¿ç”¨
- **å†…å­˜**: ~50MBï¼ˆRedisï¼‰ + ~20MBï¼ˆå®¹å™¨å¼€é”€ï¼‰
- **ç£ç›˜**: ~100MBï¼ˆé•œåƒï¼‰ + ~10MBï¼ˆæ•°æ®ï¼‰
- **å¯åŠ¨æ—¶é—´**: 15-30ç§’ï¼ˆé¦–æ¬¡è¾ƒæ…¢ï¼‰

### ä¼˜åŒ–å»ºè®®
1. **ä¿æŒå®¹å™¨è¿è¡Œ**: é¿å…é¢‘ç¹å¯åœå®¹å™¨
2. **é€‰æ‹©æ€§æµ‹è¯•**: æ—¥å¸¸å¼€å‘ä½¿ç”¨Mockæµ‹è¯•
3. **å®šæœŸæ¸…ç†**: ä½¿ç”¨å®Œå…¨æ¸…ç†é€‰é¡¹é‡Šæ”¾ç©ºé—´

## ğŸš€ CI/CDé›†æˆ

### GitHub Actionsç¤ºä¾‹
```yaml
- name: Start Redis for tests
  run: docker-compose -f docker-compose.test.yml up -d redis-test
  
- name: Wait for Redis
  run: |
    timeout 30 bash -c 'until docker exec wind-redis-test redis-cli -a windgame123 ping; do sleep 1; done'
    
- name: Run Redis tests
  run: dotnet test --filter Category=Integration
  
- name: Cleanup
  run: docker-compose -f docker-compose.test.yml down --volumes
```

## â“ å¸¸è§ç–‘é—®è§£ç­”

**Q: æˆ‘éœ€è¦å­¦ä¹ RedisçŸ¥è¯†å—ï¼Ÿ**
A: ä¸éœ€è¦ï¼è¿™å¥—ç¯å¢ƒä¸“é—¨ä¸ºæ–°æ‰‹è®¾è®¡ï¼ŒåŒå‡»è„šæœ¬å³å¯ä½¿ç”¨ã€‚

**Q: Dockerå®¹å™¨ä¼šå ç”¨å¾ˆå¤šèµ„æºå—ï¼Ÿ**
A: ä¸ä¼šã€‚Rediså®¹å™¨ä»…ä½¿ç”¨çº¦70MBå†…å­˜ï¼Œå¯¹ç³»ç»Ÿå½±å“å¾ˆå°ã€‚

**Q: å¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªæµ‹è¯•å—ï¼Ÿ**
A: å¯ä»¥ã€‚æ¯ä¸ªå®¹å™¨ä½¿ç”¨ç‹¬ç«‹çš„ç«¯å£å’Œæ•°æ®åº“ï¼Œäº’ä¸å¹²æ‰°ã€‚

**Q: æµ‹è¯•æ•°æ®ä¼šå½±å“ç”Ÿäº§ç¯å¢ƒå—ï¼Ÿ**
A: ä¸ä¼šã€‚æµ‹è¯•ä½¿ç”¨ç‹¬ç«‹çš„Dockerå®¹å™¨å’Œæ•°æ®åº“ï¼Œå®Œå…¨éš”ç¦»ã€‚

**Q: å¦‚ä½•ç¡®è®¤Redisç¡®å®åœ¨å·¥ä½œï¼Ÿ**
A: è¿è¡Œé›†æˆæµ‹è¯•ï¼Œæ£€æŸ¥å®¹å™¨æ—¥å¿—ï¼Œæˆ–ä½¿ç”¨Redis Commanderç®¡ç†ç•Œé¢ã€‚

## ğŸ”„ ç‰ˆæœ¬å…¼å®¹æ€§

- **Docker Desktop**: è¦æ±‚ 4.0+ 
- **Redis**: ä½¿ç”¨ 7.2-alpineï¼ˆLTSç‰ˆæœ¬ï¼‰
- **.NET**: å…¼å®¹ .NET 9
- **Orleans**: å…¼å®¹ 9.2.1
- **Windows**: æ”¯æŒ Windows 10/11

## ğŸ“ è·å–å¸®åŠ©

é‡åˆ°é—®é¢˜ï¼ŸæŒ‰ä¼˜å…ˆçº§æ’åºï¼š

1. **æŸ¥çœ‹æœ¬æ–‡æ¡£** çš„æ•…éšœæ’é™¤éƒ¨åˆ†
2. **æ£€æŸ¥å®¹å™¨æ—¥å¿—**: `docker logs wind-redis-test`
3. **é‡å¯ç¯å¢ƒ**: è¿è¡Œ`stop.bat`å†è¿è¡Œ`start.bat`
4. **å®Œå…¨é‡ç½®**: åœ¨åœæ­¢è„šæœ¬ä¸­é€‰æ‹©"å®Œå…¨æ¸…ç†"
5. **æ£€æŸ¥ç³»ç»Ÿ**: ç¡®ä¿Docker Desktopæ­£å¸¸è¿è¡Œ

---

**âœ¨ ç°åœ¨ä½ å·²ç»æŒæ¡äº†å®Œæ•´çš„Redisæµ‹è¯•ç¯å¢ƒï¼å¼€å§‹ä½ çš„æµ‹è¯•ä¹‹æ—…å§ï¼**

> ğŸ’¡ **å°è´´å£«**: å°†æœ¬æ–‡æ¡£åŠ å…¥æ”¶è—å¤¹ï¼Œä»¥ä¾¿éšæ—¶æŸ¥é˜…å‚è€ƒã€‚